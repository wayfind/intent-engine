# Plan.rs æ‹†åˆ†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬è„šæœ¬å°† `src/plan.rs` (2343è¡Œ) æ‹†åˆ†ä¸ºæ¨¡å—åŒ–ç»“æ„ï¼š

```
src/plan.rs (2343 lines)
    â†“
src/plan/
  â”œâ”€â”€ models.rs      (~400 lines: æ•°æ®ç»“æ„ + æµ‹è¯•)
  â”œâ”€â”€ helpers.rs     (~550 lines: è¾…åŠ©å‡½æ•° + æµ‹è¯•)
  â”œâ”€â”€ executor.rs    (~1350 lines: PlanExecutor + æµ‹è¯•)
  â””â”€â”€ mod.rs         (~50 lines: å…¬å…±æ¥å£å¯¼å‡º)
```

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### 1. æ‰§è¡Œæ‹†åˆ†è„šæœ¬

```bash
cd /mnt/d/prj/intent-engine
./scripts/split-plan-rs.sh
```

**é¢„æœŸè¾“å‡º**ï¼š
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”§ Splitting plan.rs into modular structure
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“¦ Step 1: Extracting models.rs...
âœ… Created src/plan/models.rs (XXX lines)

ğŸ“¦ Step 2: Extracting helpers.rs...
âœ… Created src/plan/helpers.rs (XXX lines)

ğŸ“¦ Step 3: Extracting executor.rs...
âœ… Created src/plan/executor.rs (XXX lines)

ğŸ“¦ Step 4: Appending dataflow_tests...
âœ… Appended dataflow_tests to executor.rs

ğŸ“¦ Step 5: Creating mod.rs...
âœ… Created src/plan/mod.rs (XXX lines)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Split completed successfully!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### 2. åˆ é™¤åŸå§‹æ–‡ä»¶

```bash
rm src/plan.rs
```

### 3. éªŒè¯ç¼–è¯‘

```bash
cargo build
```

**å¦‚æœç¼–è¯‘å¤±è´¥ï¼ŒæŸ¥çœ‹ [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤) éƒ¨åˆ†**

### 4. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰ plan æ¨¡å—æµ‹è¯•
cargo test plan::

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test
```

### 5. æ¸…ç†å¤‡ä»½ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼š
```bash
rm src/plan.rs.backup
```

## ğŸ“¦ æ‹†åˆ†è¯¦æƒ…

### models.rs (æ•°æ®ç»“æ„)

**åŒ…å«**ï¼š
- `PlanRequest` - è®¡åˆ’è¯·æ±‚ç»“æ„
- `TaskTree` - ä»»åŠ¡æ ‘å®šä¹‰
- `TaskStatus` - ä»»åŠ¡çŠ¶æ€æšä¸¾
- `PriorityValue` - ä¼˜å…ˆçº§æšä¸¾
- `PlanResult` - æ‰§è¡Œç»“æœ
- `FlatTask` - æ‰å¹³åŒ–ä»»åŠ¡
- `Operation` - æ“ä½œæšä¸¾
- ç›¸å…³æµ‹è¯•ï¼ˆ~90è¡Œï¼‰

**æµ‹è¯•è¦†ç›–**ï¼š
- ä¼˜å…ˆçº§å€¼è½¬æ¢æµ‹è¯•
- åºåˆ—åŒ–/ååºåˆ—åŒ–æµ‹è¯•
- ç»“æœæ„é€ æµ‹è¯•

### helpers.rs (è¾…åŠ©å‡½æ•°)

**åŒ…å«**ï¼š
- `extract_all_names()` - æå–æ‰€æœ‰ä»»åŠ¡å
- `flatten_task_tree()` - æ‰å¹³åŒ–ä»»åŠ¡æ ‘
- `classify_operations()` - åˆ†ç±»æ“ä½œ
- `find_duplicate_names()` - æŸ¥æ‰¾é‡å¤åç§°
- ç›¸å…³æµ‹è¯•ï¼ˆ~550è¡Œï¼‰

**æµ‹è¯•è¦†ç›–**ï¼š
- åç§°æå–æµ‹è¯•ï¼ˆç®€å•/åµŒå¥—ï¼‰
- æ ‘æ‰å¹³åŒ–æµ‹è¯•ï¼ˆæ·±åº¦åµŒå¥—/å¤šå…„å¼ŸèŠ‚ç‚¹ï¼‰
- æ“ä½œåˆ†ç±»æµ‹è¯•ï¼ˆåˆ›å»º/æ›´æ–°/æ··åˆï¼‰
- é‡å¤æ£€æµ‹æµ‹è¯•

### executor.rs (æ‰§è¡Œå¼•æ“)

**åŒ…å«**ï¼š
- `PlanExecutor` - è®¡åˆ’æ‰§è¡Œå™¨
- `execute()` - ä¸»æ‰§è¡Œæ–¹æ³•
- `find_tasks_by_names()` - æŒ‰åç§°æŸ¥æ‰¾ä»»åŠ¡
- ä¾èµ–è§£æå’Œå¾ªç¯æ£€æµ‹é€»è¾‘
- ç›¸å…³æµ‹è¯•ï¼ˆ~800è¡Œï¼‰

**æµ‹è¯•è¦†ç›–**ï¼š
- é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æ‰§è¡Œï¼‰
- å¹‚ç­‰æ€§æµ‹è¯•
- ä¾èµ–å…³ç³»æµ‹è¯•
- å¾ªç¯ä¾èµ–æ£€æµ‹æµ‹è¯•
- æ€§èƒ½æµ‹è¯•ï¼ˆ1000ä»»åŠ¡ã€20å±‚åµŒå¥—ï¼‰

### mod.rs (æ¨¡å—å¯¼å‡º)

**åŒ…å«**ï¼š
- å­æ¨¡å—å£°æ˜
- å…¬å…±ç±»å‹é‡å¯¼å‡º
- æ¨¡å—æ–‡æ¡£

## ğŸ” éªŒè¯æ¸…å•

å®Œæˆæ‹†åˆ†åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] âœ… ç¼–è¯‘é€šè¿‡ï¼š`cargo build`
- [ ] âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š`cargo test`
- [ ] âœ… Plan æ¨¡å—æµ‹è¯•é€šè¿‡ï¼š`cargo test plan::`
- [ ] âœ… æ²¡æœ‰ç¼–è¯‘è­¦å‘Šï¼ˆuseæœªä½¿ç”¨ç­‰ï¼‰
- [ ] âœ… æ–‡ä»¶æ•°é‡æ­£ç¡®ï¼š
  ```bash
  ls -1 src/plan/
  # åº”è¯¥çœ‹åˆ°ï¼š
  # executor.rs
  # helpers.rs
  # models.rs
  # mod.rs
  ```
- [ ] âœ… è¡Œæ•°ç»Ÿè®¡åˆç†ï¼š
  ```bash
  wc -l src/plan/*.rs
  # models.rs:    ~400 lines
  # helpers.rs:   ~550 lines
  # executor.rs:  ~1350 lines
  # mod.rs:       ~30 lines
  ```

## âš ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: ç¼–è¯‘é”™è¯¯ "cannot find module `plan`"

**åŸå› **: `src/lib.rs` ä¸­ç¼ºå°‘æ¨¡å—å£°æ˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ src/lib.rs æ˜¯å¦åŒ…å«ï¼š
grep "pub mod plan;" src/lib.rs

# å¦‚æœæ²¡æœ‰ï¼Œæ‰‹åŠ¨æ·»åŠ ï¼š
# åœ¨ src/lib.rs ä¸­æ·»åŠ ä¸€è¡Œï¼š
pub mod plan;
```

### é—®é¢˜2: æµ‹è¯•å¤±è´¥ "use of undeclared crate or module"

**åŸå› **: Import è·¯å¾„é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
æ£€æŸ¥ä»¥ä¸‹æ–‡ä»¶ä¸­çš„ importï¼š
- `src/plan/models.rs` - åº”è¯¥åªæœ‰ `use serde::{Deserialize, Serialize};`
- `src/plan/helpers.rs` - åº”è¯¥æœ‰ `use super::models::*;`
- `src/plan/executor.rs` - åº”è¯¥æœ‰ `use super::helpers::*; use super::models::*;`

### é—®é¢˜3: è„šæœ¬æ‰§è¡Œæƒé™é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
chmod +x ./scripts/split-plan-rs.sh
```

### é—®é¢˜4: æƒ³è¦å›æ»šæ›´æ”¹

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ¢å¤å¤‡ä»½
cp src/plan.rs.backup src/plan.rs

# åˆ é™¤ç”Ÿæˆçš„ç›®å½•
rm -rf src/plan/
```

## ğŸ“Š æ‹†åˆ†å‰åå¯¹æ¯”

| æŒ‡æ ‡ | æ‹†åˆ†å‰ | æ‹†åˆ†å | æ”¹è¿› |
|------|--------|--------|------|
| æœ€å¤§æ–‡ä»¶å¤§å° | 2343è¡Œ | ~1350è¡Œ | -42% |
| æ–‡ä»¶æ•°é‡ | 1ä¸ª | 4ä¸ª | +300% |
| å¹³å‡æ–‡ä»¶å¤§å° | 2343è¡Œ | ~588è¡Œ | -75% |
| æ¨¡å—åŒ–ç¨‹åº¦ | å•ä¸€æ–‡ä»¶ | æ¸…æ™°åˆ†å±‚ | âœ… |
| æµ‹è¯•ç»„ç»‡ | é›†ä¸­åœ¨åº•éƒ¨ | éšä»£ç åˆ†å¸ƒ | âœ… |
| Tokenæ¶ˆè€— | é«˜ | ä½ | âœ… |

## ğŸ¯ é¢„æœŸæ”¶ç›Š

âœ… **æ›´æ˜“ç»´æŠ¤**: æ¯ä¸ªæ–‡ä»¶èŒè´£å•ä¸€
âœ… **æ›´æ˜“ç†è§£**: æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ
âœ… **æ›´æ˜“æµ‹è¯•**: æµ‹è¯•å’Œä»£ç å°±è¿‘
âœ… **æ›´çœToken**: å¤„ç†å°æ–‡ä»¶æ›´é«˜æ•ˆ
âœ… **æ›´æ˜“æ‰©å±•**: æ–°åŠŸèƒ½æ·»åŠ åˆ°å¯¹åº”æ¨¡å—

## ğŸ“ åç»­å·¥ä½œ

æ‹†åˆ†å®Œæˆåï¼Œæ‚¨å¯ä»¥ï¼š

1. **ç»§ç»­æ‹†åˆ†å…¶ä»–å¤§æ–‡ä»¶**:
   - `src/main.rs` (1990è¡Œ) â†’ `src/cli_handlers/`
   - `src/dashboard/handlers.rs` (784è¡Œ)
   - `src/dashboard/websocket.rs` (882è¡Œ)

2. **ç§»é™¤ doctor/diagnose é‡å¤**ï¼ˆTrack Bï¼‰

3. **æå‡æµ‹è¯•è¦†ç›–ç‡**ï¼ˆç»§ç»­è¡¥å……ç¼ºå¤±çš„æµ‹è¯•ï¼‰

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹è„šæœ¬è¾“å‡ºä¸­çš„é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤) éƒ¨åˆ†
3. è¿è¡Œ `cargo build 2>&1 | tee build.log` ä¿å­˜å®Œæ•´é”™è¯¯æ—¥å¿—
4. æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶ `src/plan.rs.backup` ç¡®è®¤åŸå§‹å†…å®¹

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-28
**è„šæœ¬è·¯å¾„**: `scripts/split-plan-rs.sh`
**ç‰ˆæœ¬**: 0.7.1
