name: Code Coverage (Codecov)

# ‰∏ìÈó®Áî®‰∫éÁîüÊàê‰ª£Á†ÅË¶ÜÁõñÁéáÂπ∂‰∏ä‰º†Âà∞Codecov
# ÂèØ‰ª•ÊâãÂä®Ëß¶ÂèëÊàñÂú®PRÊó∂Ëá™Âä®ËøêË°å

on:
  # ÊâãÂä®Ëß¶Âèë - ÊúÄÁÆÄÂçïÁöÑÊñπÂºè
  workflow_dispatch:
    inputs:
      upload_to_codecov:
        description: '‰∏ä‰º†Âà∞Codecov'
        required: false
        type: boolean
        default: true
      verbose:
        description: 'ËØ¶ÁªÜËæìÂá∫'
        required: false
        type: boolean
        default: false

  # PRÊó∂Ëá™Âä®ËøêË°å
  pull_request:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'benches/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

  # PushÂà∞mainÊó∂ËøêË°å
  push:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  coverage:
    name: üìà Generate Coverage Report
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: üì¶ Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-

      - name: üîß Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: üß™ Generate coverage data
        run: |
          if [ "${{ inputs.verbose }}" = "true" ]; then
            cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info --verbose
          else
            cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
          fi

      - name: üìä Display coverage summary
        run: |
          echo "## üìà Code Coverage Summary"
          echo ""
          cargo llvm-cov report --summary-only
          echo ""
          echo "Full report uploaded to Codecov (if enabled)"

      - name: ‚òÅÔ∏è Upload to Codecov
        if: |
          (github.event_name == 'workflow_dispatch' && inputs.upload_to_codecov) ||
          github.event_name == 'push' ||
          github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: ${{ inputs.verbose || false }}
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: üì§ Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            lcov.info
            target/llvm-cov/html/
          retention-days: 30

      - name: ‚úÖ Coverage complete
        run: |
          echo "## ‚úÖ Coverage Report Complete"
          echo ""
          echo "- **LCOV file**: lcov.info"
          echo "- **HTML report**: target/llvm-cov/html/"
          echo "- **Uploaded to Codecov**: ${{ (github.event_name == 'workflow_dispatch' && inputs.upload_to_codecov) || github.event_name == 'push' || github.event_name == 'pull_request' }}"
          echo ""
          echo "View on Codecov: https://codecov.io/gh/${{ github.repository }}"

  # ÂèØÈÄâ: ÁîüÊàêËØ¶ÁªÜÁöÑHTMLÊä•Âëä
  coverage-html:
    name: üìÑ Generate HTML Report
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: üì¶ Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-coverage-html-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-html-

      - name: üîß Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: üìä Generate HTML coverage report
        run: cargo llvm-cov --all-features --workspace --html

      - name: üì§ Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-report
          path: target/llvm-cov/html/
          retention-days: 30

      - name: üîó Coverage report ready
        run: |
          echo "## üìÑ HTML Coverage Report Generated"
          echo ""
          echo "Download the artifact 'coverage-html-report' to view locally."
          echo "Open index.html in your browser."

  # ÁîüÊàêÊëòË¶ÅËØÑËÆ∫(‰ªÖPR)
  coverage-comment:
    name: üí¨ Post Coverage Comment
    runs-on: ubuntu-latest
    needs: coverage
    if: github.event_name == 'pull_request'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v5

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: üîß Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: üìä Generate coverage summary
        run: |
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

          # Extract coverage percentage
          COVERAGE=$(cargo llvm-cov report --summary-only | grep -oP 'TOTAL\s+\K[\d.]+(?=%)')

          echo "coverage_percent=$COVERAGE" >> $GITHUB_ENV

      - name: üí¨ Create coverage comment
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = process.env.coverage_percent;
            const emoji = coverage >= 80 ? 'üéâ' : coverage >= 60 ? '‚úÖ' : '‚ö†Ô∏è';

            const comment = `## ${emoji} Code Coverage Report

            **Total Coverage**: ${coverage}%

            ${coverage >= 80 ? 'üéâ Excellent coverage!' : coverage >= 60 ? '‚úÖ Good coverage' : '‚ö†Ô∏è Coverage could be improved'}

            [View detailed report on Codecov](https://codecov.io/gh/${{ github.repository }}/pull/${{ github.event.pull_request.number }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
