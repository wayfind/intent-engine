name: Update Homebrew Formula

# Automatically update homebrew-tap after a successful release
# This workflow is triggered when a new release is published

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.10.1)'
        required: true
        type: string

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest

    steps:
      - name: Checkout intent-engine
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION (tag: $TAG)"

      - name: Download release assets and calculate SHA256
        id: sha256
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"

          echo "Downloading release assets for v${VERSION}..."

          # Download and calculate SHA256 for each platform
          for platform in macos-aarch64 macos-x86_64 linux-aarch64 linux-x86_64; do
            url="${BASE_URL}/intent-engine-${platform}.tar.gz"
            echo "Downloading ${platform}..."

            if curl -sL "$url" -o "${platform}.tar.gz"; then
              sha256=$(sha256sum "${platform}.tar.gz" | cut -d' ' -f1)
              # Use underscores for output variable names
              var_name="${platform//-/_}_sha256"
              echo "${var_name}=${sha256}" >> $GITHUB_OUTPUT
              echo "  ${platform}: ${sha256}"
            else
              echo "::error::Failed to download ${url}"
              exit 1
            fi
          done

      - name: Generate and push formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Generate formula content
          cat > intent-engine.rb << EOF
          class IntentEngine < Formula
            desc "AI long-term task memory system - cross-session persistence, hierarchical tasks, decision records"
            homepage "https://github.com/wayfind/intent-engine"
            version "${VERSION}"
            license "MIT OR Apache-2.0"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/wayfind/intent-engine/releases/download/v#{version}/intent-engine-macos-aarch64.tar.gz"
                sha256 "${{ steps.sha256.outputs.macos_aarch64_sha256 }}"
              else
                url "https://github.com/wayfind/intent-engine/releases/download/v#{version}/intent-engine-macos-x86_64.tar.gz"
                sha256 "${{ steps.sha256.outputs.macos_x86_64_sha256 }}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/wayfind/intent-engine/releases/download/v#{version}/intent-engine-linux-aarch64.tar.gz"
                sha256 "${{ steps.sha256.outputs.linux_aarch64_sha256 }}"
              else
                url "https://github.com/wayfind/intent-engine/releases/download/v#{version}/intent-engine-linux-x86_64.tar.gz"
                sha256 "${{ steps.sha256.outputs.linux_x86_64_sha256 }}"
              end
            end

            def install
              bin.install "ie"
            end

            test do
              system "#{bin}/ie", "--version"
            end
          end
          EOF

          echo "Generated formula:"
          cat intent-engine.rb

          # Clone homebrew-tap repo and update
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/wayfind/homebrew-tap.git" homebrew-tap
          cd homebrew-tap

          # Create Formula directory if it doesn't exist
          mkdir -p Formula

          # Copy the formula
          cp ../intent-engine.rb Formula/intent-engine.rb

          # Configure git
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # Commit and push
          git add Formula/intent-engine.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update intent-engine to ${VERSION}"
            git push origin main
            echo "âœ… Formula updated successfully"
          fi

      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## ðŸº Homebrew Formula Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "brew tap wayfind/tap" >> $GITHUB_STEP_SUMMARY
          echo "brew install intent-engine" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA256 Checksums" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM64 | \`${{ steps.sha256.outputs.macos_aarch64_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS x86_64 | \`${{ steps.sha256.outputs.macos_x86_64_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux ARM64 | \`${{ steps.sha256.outputs.linux_aarch64_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux x86_64 | \`${{ steps.sha256.outputs.linux_x86_64_sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
