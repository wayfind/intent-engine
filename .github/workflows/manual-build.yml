name: Manual Build

# ğŸ¯ æ‰‹åŠ¨æ„å»ºå·¥ä½œæµ
#
# æä¾›çµæ´»çš„æ‰‹åŠ¨è§¦å‘é€‰é¡¹ï¼Œç”¨äºï¼š
# - è°ƒè¯•ç‰¹å®šå¹³å°çš„æ„å»ºé—®é¢˜
# - è¿è¡Œç‰¹å®šçš„æµ‹è¯•å¥—ä»¶
# - éªŒè¯å‘å¸ƒå‰çš„æ„å»º
# - æµ‹è¯•ç‰¹å®šçš„Rustç‰ˆæœ¬
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. åœ¨GitHubä»“åº“é¡µé¢ç‚¹å‡» "Actions" æ ‡ç­¾
# 2. é€‰æ‹© "Manual Build" workflow
# 3. ç‚¹å‡» "Run workflow" æŒ‰é’®
# 4. é€‰æ‹©ä½ éœ€è¦çš„é€‰é¡¹
# 5. ç‚¹å‡»ç»¿è‰²çš„ "Run workflow" æŒ‰é’®

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        type: choice
        default: 'quick-check'
        options:
          - quick-check        # å¿«é€Ÿæ£€æŸ¥ï¼ˆæ ¼å¼+clippy+ç¼–è¯‘ï¼‰
          - full-test          # å®Œæ•´æµ‹è¯•ï¼ˆæ‰€æœ‰æµ‹è¯•å¥—ä»¶ï¼‰
          - cross-platform     # è·¨å¹³å°æ„å»º
          - release-build      # Releaseæ„å»º
          - bench             # æ€§èƒ½åŸºå‡†æµ‹è¯•
          - coverage          # ä»£ç è¦†ç›–ç‡
          - security-audit    # å®‰å…¨å®¡è®¡
          - all               # è¿è¡Œæ‰€æœ‰æ£€æŸ¥

      rust_version:
        description: 'Rustç‰ˆæœ¬'
        required: true
        type: choice
        default: 'stable'
        options:
          - stable
          - beta
          - nightly
          - '1.75'  # æœ€å°æ”¯æŒç‰ˆæœ¬

      platform:
        description: 'ç›®æ ‡å¹³å° (ä»…ç”¨äºcross-platformæ„å»º)'
        required: false
        type: choice
        default: 'all'
        options:
          - all
          - linux-x64
          - linux-arm64
          - macos-x64
          - macos-arm64
          - windows-x64

      verbose:
        description: 'è¯¦ç»†è¾“å‡º'
        required: false
        type: boolean
        default: false

      skip_cache:
        description: 'è·³è¿‡ç¼“å­˜'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: ${{ inputs.verbose && 'full' || '1' }}

jobs:
  # æ˜¾ç¤ºæ„å»ºé…ç½®
  show-config:
    name: ğŸ“‹ Build Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Display build configuration
        run: |
          echo "## ğŸ”§ Build Configuration"
          echo ""
          echo "- **Build Type**: ${{ inputs.build_type }}"
          echo "- **Rust Version**: ${{ inputs.rust_version }}"
          echo "- **Platform**: ${{ inputs.platform }}"
          echo "- **Verbose**: ${{ inputs.verbose }}"
          echo "- **Skip Cache**: ${{ inputs.skip_cache }}"
          echo "- **Triggered by**: ${{ github.actor }}"
          echo "- **Branch**: ${{ github.ref_name }}"
          echo "- **Commit**: ${{ github.sha }}"

  # å¿«é€Ÿæ£€æŸ¥
  quick-check:
    name: âš¡ Quick Check
    runs-on: ubuntu-latest
    if: |
      inputs.build_type == 'quick-check' ||
      inputs.build_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust_version }}
          components: rustfmt, clippy

      - name: Cache cargo (if enabled)
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ inputs.rust_version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check compilation
        run: cargo check --all-targets --all-features ${{ inputs.verbose && '--verbose' || '' }}

  # å®Œæ•´æµ‹è¯•
  full-test:
    name: ğŸ§ª Full Test Suite
    runs-on: ubuntu-latest
    if: |
      inputs.build_type == 'full-test' ||
      inputs.build_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust_version }}

      - name: Cache cargo (if enabled)
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ inputs.rust_version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run all tests
        run: cargo test --all-features ${{ inputs.verbose && '--verbose' || '' }}

      - name: Run ignored tests
        run: cargo test --all-features -- --ignored ${{ inputs.verbose && '--verbose' || '' }}

      - name: Run doc tests
        run: cargo test --doc ${{ inputs.verbose && '--verbose' || '' }}

  # è·¨å¹³å°æ„å»º
  cross-platform:
    name: ğŸŒ Cross Platform Build
    if: |
      inputs.build_type == 'cross-platform' ||
      inputs.build_type == 'all'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux-x64

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            name: linux-arm64

          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-x64

          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust_version }}
          targets: ${{ matrix.target }}

      - name: Cache cargo (if enabled)
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ matrix.os }}-cargo-${{ matrix.target }}-${{ inputs.rust_version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build for ${{ matrix.name }}
        run: cargo build --release --target ${{ matrix.target }} ${{ inputs.verbose && '--verbose' || '' }}

      - name: Run tests (native only)
        if: matrix.target == 'x86_64-unknown-linux-gnu' || matrix.target == 'x86_64-apple-darwin' || matrix.target == 'x86_64-pc-windows-msvc'
        run: cargo test --release --target ${{ matrix.target }}

  # Releaseæ„å»º
  release-build:
    name: ğŸ“¦ Release Build
    runs-on: ubuntu-latest
    if: |
      inputs.build_type == 'release-build' ||
      inputs.build_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust_version }}

      - name: Cache cargo (if enabled)
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ inputs.rust_version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --all-features ${{ inputs.verbose && '--verbose' || '' }}

      - name: Verify binaries
        run: |
          echo "## ğŸ“¦ Binary Information"
          echo ""
          ls -lh target/release/intent-engine*
          echo ""
          echo "### intent-engine binary:"
          file target/release/intent-engine
          ./target/release/intent-engine --version
          echo ""
          echo "### intent-engine-mcp-server binary:"
          file target/release/intent-engine-mcp-server
          echo '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | ./target/release/intent-engine-mcp-server | jq -r '.result.tools | length' | xargs -I {} echo "MCP server has {} tools"

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: intent-engine-${{ inputs.rust_version }}-linux-x64
          path: |
            target/release/intent-engine
            target/release/intent-engine-mcp-server
          retention-days: 7

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark:
    name: ğŸ“Š Benchmarks
    runs-on: ubuntu-latest
    if: |
      inputs.build_type == 'bench' ||
      inputs.build_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust_version }}

      - name: Cache cargo (if enabled)
        if: ${{ !inputs.skip_cache }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-bench-${{ inputs.rust_version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run benchmarks
        run: cargo bench ${{ inputs.verbose && '--verbose' || '' }}

  # ä»£ç è¦†ç›–ç‡
  coverage:
    name: ğŸ“ˆ Code Coverage
    runs-on: ubuntu-latest
    if: |
      inputs.build_type == 'coverage' ||
      inputs.build_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ inputs.rust_version }}

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage
        run: cargo tarpaulin --out Xml --all-features ${{ inputs.verbose && '--verbose' || '' }}

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./cobertura.xml
          flags: manual-build
          fail_ci_if_error: false

  # å®‰å…¨å®¡è®¡
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    if: |
      inputs.build_type == 'security-audit' ||
      inputs.build_type == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Check for vulnerabilities
        run: |
          if cargo audit --json | jq -e '.vulnerabilities.list | length > 0'; then
            echo "âš ï¸ Security vulnerabilities found!"
            cargo audit
            exit 1
          else
            echo "âœ… No security vulnerabilities found"
          fi

  # æ„å»ºæ‘˜è¦
  summary:
    name: ğŸ“ Build Summary
    runs-on: ubuntu-latest
    needs: [show-config, quick-check, full-test, cross-platform, release-build, benchmark, coverage, security-audit]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ğŸ‰ Manual Build Complete"
          echo ""
          echo "### Configuration"
          echo "- Build Type: ${{ inputs.build_type }}"
          echo "- Rust Version: ${{ inputs.rust_version }}"
          echo "- Platform: ${{ inputs.platform }}"
          echo ""
          echo "### Results"
          echo "- Quick Check: ${{ needs.quick-check.result }}"
          echo "- Full Test: ${{ needs.full-test.result }}"
          echo "- Cross Platform: ${{ needs.cross-platform.result }}"
          echo "- Release Build: ${{ needs.release-build.result }}"
          echo "- Benchmarks: ${{ needs.benchmark.result }}"
          echo "- Coverage: ${{ needs.coverage.result }}"
          echo "- Security Audit: ${{ needs.security-audit.result }}"
          echo ""
          echo "**Triggered by**: @${{ github.actor }}"
          echo "**Branch**: ${{ github.ref_name }}"
